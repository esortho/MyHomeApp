<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard V2 - MyHome App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom styles can be added here if needed */
        .card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .metric-value {
            font-size: 2.5rem; /* Larger font for key metrics */
            font-weight: 600;
            color: #1f2937; /* Dark gray */
        }
        .metric-label {
            font-size: 0.875rem;
            color: #6b7280; /* Medium gray */
            margin-bottom: 5px;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #2563eb; /* Blue color */
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-8">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800">Dashboard V2</h1>
        <a href="/" class="text-blue-600 hover:text-blue-800">Back to Index</a>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column / Main Column (Measurements) -->
        <div class="lg:col-span-2">
            <!-- Key Metrics -->
            <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 mb-6">
                <div class="card text-center">
                    <div class="metric-label">Temperature</div>
                    <div id="temp-value" class="metric-value">-</div>
                    <div class="text-xs text-gray-500">Updated: <span id="temp-time">-</span></div>
                </div>
                <div class="card text-center">
                    <div class="metric-label">pH Level</div>
                    <div id="ph-value" class="metric-value">-</div>
                     <div class="text-xs text-gray-500">Updated: <span id="ph-time">-</span></div>
               </div>
                <div class="card text-center">
                    <div class="metric-label">Redox</div>
                    <div id="redox-value" class="metric-value">-</div>
                     <div class="text-xs text-gray-500">Updated: <span id="redox-time">-</span></div>
               </div>
                <div class="card text-center">
                    <div class="metric-label">Flow Status</div>
                    <div id="flow-value" class="metric-value">-</div>
                    <div class="text-xs text-gray-500">Updated: <span id="flow-time">-</span></div>
                </div>
            </div>

            <!-- Historical Trend Charts -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Temperature Chart -->
                <div class="card">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Temperature Trend (Last 24h)</h2>
                    <div id="temperature-chart-container" style="position: relative; height:300px;">
                        <canvas id="temperatureChart"></canvas>
                    </div>
                    <div id="temperature-chart-loading" class="text-center text-gray-500 py-10">Loading chart data...</div>
                </div>

                <!-- Flow Chart -->
                <div class="card">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Flow Status (Last 24h)</h2>
                    <div id="flow-chart-container" style="position: relative; height:300px;">
                        <canvas id="flowChart"></canvas>
                    </div>
                    <div id="flow-chart-loading" class="text-center text-gray-500 py-10">Loading chart data...</div>
                </div>
            </div>

            <!-- All Measurements Table -->
            <div class="card">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Current Measurements</h2>
                <div id="measurements-table-loading" class="text-center text-gray-500 py-4">Loading measurements...</div>
                <table class="min-w-full divide-y divide-gray-200 hidden" id="measurements-table">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Measurement</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Value</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Updated</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="measurements-tbody">
                        <!-- Data rows will be inserted here -->
                    </tbody>
                </table>
                <div id="measurements-error" class="text-center text-red-500 py-4 hidden">Failed to load measurements.</div>
            </div>
        </div>

        <!-- Right Column (Lights) -->
        <div class="lg:col-span-1">
            <div class="card">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Lights Control</h2>
                <div id="lights-loading" class="text-center text-gray-500 py-4">Loading lights...</div>
                <div id="lights-list" class="space-y-3 hidden">
                    <!-- Light items will be inserted here -->
                </div>
                <div id="lights-error" class="text-center text-red-500 py-4 hidden">Failed to load lights.</div>
            </div>
        </div>
    </div>

    <script>
        let temperatureChart = null;
        let flowChart = null;

        // --- Data Fetching ---
        async function fetchMeasurements() {
            try {
                const response = await fetch('/api/measurements');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                displayMeasurements(data);
                // Fetch historical data for charts
                await Promise.all([
                    fetchHistoricalTemperature(),
                    fetchHistoricalFlow()
                ]);
                hideMeasurementError();
            } catch (error) {
                console.error('Error fetching measurements:', error);
                showMeasurementError();
                // Also show error for dependent elements
                document.getElementById('temperature-chart-loading').textContent = 'Error loading chart data.';
                document.getElementById('flow-chart-loading').textContent = 'Error loading chart data.';
                document.getElementById('measurements-table-loading').textContent = 'Error loading table data.';
            }
        }

        async function fetchHistoricalTemperature() {
            try {
                const url = '/api/measurements/history?type=water_temperature&duration=24h';
                console.log('Fetching historical temperature data from:', url);
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log('Historical temperature data:', data);
                createOrUpdateTemperatureChart(data);
            } catch (error) {
                console.error('Error fetching historical temperature data:', error);
                document.getElementById('temperature-chart-loading').textContent = 'Error loading chart data.';
            }
        }

        async function fetchHistoricalFlow() {
            try {
                const url = '/api/measurements/history?type=water_flow&duration=24h';
                console.log('Fetching historical flow data from:', url);
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log('Historical flow data:', data);
                createOrUpdateFlowChart(data);
            } catch (error) {
                console.error('Error fetching historical flow data:', error);
                document.getElementById('flow-chart-loading').textContent = 'Error loading chart data.';
            }
        }

        async function fetchLights() {
            try {
                const response = await fetch('/api/lights');
                 if (!response.ok) {
                     if (response.status === 501) { // Not Implemented
                         showLightsError("Lights API endpoint is not implemented yet.");
                         return; // Stop processing if endpoint not implemented
                     }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                displayLights(data);
                hideLightsError();
            } catch (error) {
                console.error('Error fetching lights:', error);
                showLightsError("Failed to load lights.");
            }
        }

        async function toggleLight(lightId, currentState) {
            try {
                const response = await fetch(`/api/lights/${lightId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ on: !currentState }),
                });
                if (!response.ok) {
                     if (response.status === 501) { // Not Implemented
                         alert("Toggling lights is not implemented yet.");
                         // Revert UI change
                         const checkbox = document.getElementById(`light-toggle-${lightId}`);
                         if(checkbox) checkbox.checked = currentState;
                         return;
                     }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                // Refresh lights data on successful toggle
                fetchLights();
            } catch (error) {
                console.error('Error toggling light:', error);
                alert('Failed to toggle light. Please try again.');
                 // Revert UI change
                 const checkbox = document.getElementById(`light-toggle-${lightId}`);
                 if(checkbox) checkbox.checked = currentState;
           }
        }

         // --- UI Updates ---

        function showMeasurementError() {
            document.getElementById('measurements-error').classList.remove('hidden');
            document.getElementById('measurements-table').classList.add('hidden');
            document.getElementById('measurements-table-loading').classList.add('hidden');
            // Clear key metrics on error
            updateKeyMetric('temp', '-', '-');
            updateKeyMetric('ph', '-', '-');
            updateKeyMetric('redox', '-', '-');
            updateKeyMetric('flow', '-', '-');
         }

        function hideMeasurementError() {
            document.getElementById('measurements-error').classList.add('hidden');
        }

        function showLightsError(message = "Failed to load lights.") {
            const errorDiv = document.getElementById('lights-error');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            document.getElementById('lights-list').classList.add('hidden');
            document.getElementById('lights-loading').classList.add('hidden');
        }

        function hideLightsError() {
            document.getElementById('lights-error').classList.add('hidden');
        }

         function updateKeyMetric(type, value, time) {
            const valueEl = document.getElementById(`${type}-value`);
            const timeEl = document.getElementById(`${type}-time`);
            const cardEl = valueEl ? valueEl.closest('.card') : null;
             const formattedTime = time === '-' ? '-' : new Date(time).toLocaleTimeString();

            if (valueEl) {
                valueEl.textContent = value;
                // Add color coding for flow status
                if (type === 'flow') {
                    if (value === 'Yes') {
                        valueEl.style.color = '#000000'; // Black text
                        if (cardEl) {
                            cardEl.style.backgroundColor = '#059669'; // Green-600 background
                        }
                    } else if (value === 'No') {
                        valueEl.style.color = '#000000'; // Black text
                        if (cardEl) {
                            cardEl.style.backgroundColor = '#dc2626'; // Red-600 background
                        }
                    } else {
                        valueEl.style.color = '#1f2937'; // Default gray text
                        if (cardEl) {
                            cardEl.style.backgroundColor = '#ffffff'; // White background
                        }
                    }
                }
            }
            if (timeEl) timeEl.textContent = formattedTime;
        }

        function displayMeasurements(data) {
            console.log('Received measurements:', data); // Debug log

            const tableLoading = document.getElementById('measurements-table-loading');
            const table = document.getElementById('measurements-table');
            const tbody = document.getElementById('measurements-tbody');

            tableLoading.classList.add('hidden');
            table.classList.remove('hidden');
            tbody.innerHTML = ''; // Clear previous data

            if (!data || Object.keys(data).length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">No measurements available.</td></tr>';
                // Clear key metrics if no data
                updateKeyMetric('temp', '-', '-');
                updateKeyMetric('ph', '-', '-');
                updateKeyMetric('redox', '-', '-');
                updateKeyMetric('flow', '-', '-');
                return;
            }

            // Update key metrics and build table rows
            Object.entries(data).forEach(([key, measurement]) => {
                console.log('Processing measurement:', key, measurement); // Debug log
                const value = measurement.value !== undefined ? measurement.value.toFixed(2) : 'N/A';
                const unit = measurement.unit || '';
                const updatedAt = measurement.updatedAt ? new Date(measurement.updatedAt) : null;
                const formattedTime = updatedAt ? updatedAt.toLocaleString() : '-';

                // Update key metrics (case-insensitive matching)
                const keyLower = key.toLowerCase();
                if (keyLower === 'temp') {
                    console.log('Found temperature:', value); // Debug log
                    updateKeyMetric('temp', `${value}°C`, measurement.updatedAt);
                } else if (keyLower === 'ph') {
                    updateKeyMetric('ph', value, measurement.updatedAt);
                } else if (keyLower === 'redox') {
                    updateKeyMetric('redox', `${value} mV`, measurement.updatedAt);
                } else if (keyLower === 'waterflow') {
                    updateKeyMetric('flow', value > 0 ? 'Yes' : 'No', measurement.updatedAt);
                }

                // Add row to table
                const row = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${key}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${value}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${unit}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formattedTime}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }


        function displayLights(lights) {
            const loading = document.getElementById('lights-loading');
            const list = document.getElementById('lights-list');
            loading.classList.add('hidden');
            list.classList.remove('hidden');
            list.innerHTML = ''; // Clear previous lights

             if (!lights || lights.length === 0) {
                 list.innerHTML = '<div class="text-center text-gray-500 py-4">No lights found or API not implemented.</div>';
                 return;
             }

            lights.forEach(light => {
                const lightElement = document.createElement('div');
                lightElement.className = 'flex items-center justify-between p-3 bg-gray-50 rounded';
                lightElement.innerHTML = `
                    <span class="text-sm font-medium text-gray-700">${light.name || `Light ${light.id}`}</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="light-toggle-${light.id}" ${light.state && light.state.on ? 'checked' : ''}>
                        <span class="slider"></span>
                    </label>
                `;
                 list.appendChild(lightElement);

                // Add event listener for the toggle
                const toggle = lightElement.querySelector(`#light-toggle-${light.id}`);
                 if (toggle) {
                     toggle.addEventListener('change', () => {
                         toggleLight(light.id, !toggle.checked); // Pass the PREVIOUS state
                     });
                 }
            });
        }

        // --- Charting ---
        function displayChartPlaceholder() {
            // This function now just ensures the loading message is handled correctly
            // The actual chart creation will happen when historical data is fetched
            document.getElementById('temperature-chart-loading').classList.remove('hidden'); // Show loading initially
        }

        function createOrUpdateTemperatureChart(historicalData) {
            console.log('Creating/updating temperature chart with data:', historicalData);
            const chartLoading = document.getElementById('temperature-chart-loading');
            const ctx = document.getElementById('temperatureChart').getContext('2d');

            if (!historicalData || historicalData.length === 0) {
                console.log('No historical temperature data available');
                chartLoading.textContent = 'No historical data available.';
                chartLoading.classList.remove('hidden');
                if (temperatureChart) {
                    temperatureChart.destroy();
                    temperatureChart = null;
                }
                return;
            }

            chartLoading.classList.add('hidden');

            const labels = historicalData.map(d => new Date(d.Timestamp).toLocaleTimeString());
            const values = historicalData.map(d => d.Value);

            if (temperatureChart) {
                console.log('Updating existing temperature chart');
                temperatureChart.data.labels = labels;
                temperatureChart.data.datasets[0].data = values;
                temperatureChart.update();
            } else {
                console.log('Creating new temperature chart');
                temperatureChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Temperature',
                            data: values,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1,
                            fill: false,
                            pointRadius: 2,
                            pointHoverRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                min: 15,
                                max: 38,
                                ticks: {
                                    stepSize: 2
                                }
                            },
                            x: {
                                ticks: {
                                    maxTicksLimit: 10
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Temperature: ${context.parsed.y.toFixed(1)}°C`;
                                    }
                                }
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        }
                    }
                });
            }
        }

        function createOrUpdateFlowChart(historicalData) {
            console.log('Creating/updating flow chart with data:', historicalData);
            const chartLoading = document.getElementById('flow-chart-loading');
            const ctx = document.getElementById('flowChart').getContext('2d');

            if (!historicalData || historicalData.length === 0) {
                console.log('No historical flow data available');
                chartLoading.textContent = 'No historical data available.';
                chartLoading.classList.remove('hidden');
                if (flowChart) {
                    flowChart.destroy();
                    flowChart = null;
                }
                return;
            }

            chartLoading.classList.add('hidden');

            const labels = historicalData.map(d => new Date(d.Timestamp).toLocaleTimeString());
            const values = historicalData.map(d => d.Value > 0 ? 1 : 0);

            if (flowChart) {
                console.log('Updating existing flow chart');
                flowChart.data.labels = labels;
                flowChart.data.datasets[0].data = values;
                flowChart.update();
            } else {
                console.log('Creating new flow chart');
                flowChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Flow',
                            data: values,
                            borderColor: 'rgb(79, 70, 229)',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            tension: 0,
                            fill: true,
                            pointRadius: 0,
                            pointHoverRadius: 4,
                            stepped: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                min: 0,
                                max: 1,
                                ticks: {
                                    stepSize: 1,
                                    callback: function(value) {
                                        return value === 1 ? 'On' : 'Off';
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    maxTicksLimit: 10
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Flow: ${context.parsed.y === 1 ? 'On' : 'Off'}`;
                                    }
                                }
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        }
                    }
                });
            }
        }

        // --- Initialization and Interval ---
        function fetchData() {
            fetchMeasurements();
            fetchLights();
            // TODO: Add fetchHistoricalMeasurements() here when ready
        }

        // Initial fetch
        fetchData();

        // Refresh data every 30 seconds
        setInterval(fetchData, 30000);

    </script>
</body>
</html> 